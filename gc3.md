# ProtoXEP: Group Chat 3

## What

## How

### Identifying channels

Channels are identified with a bare JID where the domain part is the service on which the channel resides and the localpart is an opaque identifier for the channel, generated by the service at creation time. The name of the channel is returned in disco#items responses on the service, and in the channel's configuration. This allows channels to have their presented name changed without breaking addressing, as would happen in MUC. e.g. `UHJhaXNlIEtldgo@gc3service.example.com`.

### Identifying participants in a channel

Occupants have a stable identifier, much as [XEP-0421](https://xmpp.org/extensions/xep-0421.html). The occupant is identified by the JID of the channel, plus the occupant's identifier as the resource giving a full JID. This is similar to MUC, except that the user identifier is not their nickname. e.g. `UHJhaXNlIEtldgo@gc3service.example.com/VGhpcyBpcyBLZXYK` - this is called the "Participant JID".

### Joining a channel

#### Client requests form from channel

A client can (optionally, but suggested) request the join configuration form before trying to join the room by sending an iq get

```xml
<iq
    from='hag66@shakespeare.lit/pda'
    id='ia324fih'
    to='UHJhaXNlIEtldgo@c3service.example.com'
    type='get'>
  <join-form xmlns="urn:xmpp:gc3:0"/>
</iq>
```

The server responds with a form with fields, some of which may be mandatory.

```xml
<iq
    to='hag66@shakespeare.lit/pda'
    id='ia324fih'
    from='UHJhaXNlIEtldgo@c3service.example.com'
    type='result'>
  <join-form xmlns="urn:xmpp:gc3:0">
    <x xmlns='jabber:x:data' type='form'>
      <title>Join options</title>
      <instructions>Fill out this form to configure your join</instructions>
      <field type='hidden'
             var='FORM_TYPE'>
        <value>urn:xmpp:gc3:join-form</value>
      </field>
      <field type='text-single'
             label='Nickname'
             var='urn:xmpp:gc3:fields:nickname'>
         <required/>
      </field>
  </join>
</iq>
```

A field whose var is `urn:xmpp:gc3:fields:nickname` is always the user's nickname in the room, and clients might wish to special-case presentation of this field.

#### Client sends iq to channel with join details

Client sends an iq set, optionally including the form. Not including the form is the same as including the form with no fields. Not including a field is an instruction to use the default value for that field. Not including a mandatory field is an error (TODO: Define error case so client knows that it needs to re-request the form to submit mandatory fields).

```xml
<iq
    from='hag66@shakespeare.lit/pda'
    id='39dhs'
    to='UHJhaXNlIEtldgo@c3service.example.com'
    type='set'>
  <join xmlns="urn:xmpp:gc3:0">
    <x xmlns='jabber:x:data' type='form'>
      <field type='hidden'
             var='FORM_TYPE'>
        <value>urn:xmpp:gc3:join-form</value>
      </field>
      <field type='text-single'
             var='urn:xmpp:gc3:fields:nickname'>
         <value>Haggish</value>
      </field>
  </join>
</iq>
```

#### Channel responds with result containing join details

```xml
<iq
    to='hag66@shakespeare.lit/pda'
    id='39dhs'
    from='UHJhaXNlIEtldgo@c3service.example.com'
    type='result'>
  <joined xmlns="urn:xmpp:gc3:0">
    <subscription-jid>UHJhaXNlIEtldgo@c3service.example.com</subscription-jid>
  </joined>
</iq>
```

The channel responds telling the user what room JID they should expect the presence subscription request from. This allows for room aliases (e.g. `coven@gc3service.example.com` being a friendly alias that a user can join for the channel whose opaque JID is really `UHJhaXNlIEtldgo@c3service.example.com`).

#### Channel sends subscription request

The channel then MUST respond with a subscription request.

```xml
<presence to='hag66@shakespeare.lit'
    from='UHJhaXNlIEtldgo@c3service.example.com'
    type='subscribe'/>
```

#### Client autoaccepts subscription request

The client then checks the request is from the room JID returned from the iq in the `subscription-jid` element, and if so MUST auto-approve it.

```xml
<presence from='hag66@shakespeare.lit/pda'
    to='UHJhaXNlIEtldgo@c3service.example.com'
    type='subscribed'/>
```

#### Client adds channel to private 'joined channels' node

The client then adds the channel to the private 'joined channels' node. (TODO: Basically bookmarks2, but for tracking joined GC3 rooms).

### Creating a channel

Creating a channel follows the same flow as joining, but with a `create-form` and `create` instead of `join-form` and `join`. The subscription flow follows the same.

### Subscribing to receive data from a channel

A participant entity is not subscribed to messages, presence, or other data for channels they're in by default. Instead the entity selects which data it wants to receive.

#### Subscribing to messages on all channels

A participant entity advertises that they want to receive messages for all channels by advertising the `urn:xmpp:gc3:0:default-receive:message` feature in their disco+caps of their initial broadcast presence. If a channel receives initial presence from a participant's full JID containing this feature, the participant should be subscribed to messages on the channel until either the channel receives an unavailable at the end of the presence session, or the participant explicitly unsubscribes from messages (see below). A client that always advertises this feature could avoid implementing the explicit subscription flow and will get behaviour very much like MUC.

An entity SHOULD NOT add or remove this value during a presence session, and channels are not expected to reevaluate a participant's presence after their initial presence broadcast for a session.

#### Subscribing to presence on all channels

Presence works as messages, but with an advertised feature of `urn:xmpp:gc3:0:default-receive:presence`.

#### Subscribing to participant changes on all channels

GC3 splits the MUC concepts of occupancy and presence. To receive updates to the participant list, do the same but with `urn:xmpp:gc3:0:default-receive:participants`.

#### Explicit subscription

A participant can subscribe to messages, presence or participant changes by sending an iq

```xml
<iq
    from='hag66@shakespeare.lit/pda'
    id='ia324fih'
    to='UHJhaXNlIEtldgo@c3service.example.com'
    type='set'>
  <subscribe xmlns="urn:xmpp:gc3:0" type="message"/>
</iq>
```

where the `type` is `message`, `presence` or `participant` respectively.

#### Explicit unsubscription

Similarly:

```xml
<iq
    from='hag66@shakespeare.lit/pda'
    id='2iardh3'
    to='UHJhaXNlIEtldgo@c3service.example.com'
    type='set'>
  <unsubscribe xmlns="urn:xmpp:gc3:0" type="message"/>
</iq>
```

Note that explicit subscription and unsubscription override the `default-receive`, but a full JID is always unsubscribed when the channel receives an `unavailable` presence.

### Sending a message to a channel

This happens as it did in MUC.

```xml
<message
    from='hag66@shakespeare.lit/pda'
    id='hysf1v37'
    to='UHJhaXNlIEtldgo@c3service.example.com'
    type='groupchat'>
  <body>Harpier cries: 'tis time, 'tis time.</body>
</message>
```

The channel then checks if the participant is allowed to send a message to the channel, and if so it distributes it to those participants allowed to see messages in the channel who are currently subscribed to messages). If the user is not authorised to send a message to the channel, an error is returned.

### Receiving messages from a channel

When the channel distributes a received message it sends it from the participant's Participant JID. As channels are required to implement MAM, it'll always contain a [stanza-id](https://xmpp.org/extensions/xep-0359.html).

```xml
<message
    from='UHJhaXNlIEtldgo@c3service.example.com/414ff9c3-c5d4-4d4a-bce9-085b9ab08979'
    id='hysf1v37'
    to='crone1@shakespeare.lit/desktop'
    type='groupchat'>
  <body>Harpier cries: 'tis time, 'tis time.</body>
  <stanza-id xmlns='urn:xmpp:sid:0'
             by='UHJhaXNlIEtldgo@c3service.example.com'
             id='28482-98726-73623' />
</message>
<message
    from='UHJhaXNlIEtldgo@c3service.example.com/414ff9c3-c5d4-4d4a-bce9-085b9ab08979'
    id='hysf1v37'
    to='wiccarocks@shakespeare.lit/laptop'
    type='groupchat'>
  <body>Harpier cries: 'tis time, 'tis time.</body>
  <stanza-id xmlns='urn:xmpp:sid:0'
             by='UHJhaXNlIEtldgo@c3service.example.com'
             id='28482-98726-73623' />
</message>
<message
    from='UHJhaXNlIEtldgo@c3service.example.com/414ff9c3-c5d4-4d4a-bce9-085b9ab08979'
    id='hysf1v37'
    to='hag66@shakespeare.lit/pda'
    type='groupchat'>
  <body>Harpier cries: 'tis time, 'tis time.</body>
  <stanza-id xmlns='urn:xmpp:sid:0'
             by='UHJhaXNlIEtldgo@c3service.example.com'
             id='28482-98726-73623' />
</message>
```

### Sending presence to a channel

As a presence subscription is established during join of a channel, a GC3 client SHOULD NOT send directed presence to a channel. A user's presence will be distributed by their server as part of the usual presence broadcast.

### Receiving presence from a channel

### Querying occupant list for channel

### Channel roles and affiliations

### Channel configuration

### Inviting to a channel

### Channel address aliases

### Configuring a user's membership of the channel (changing nick, xep4 form)

### Main changes from MUC

* Channel naming/addressing is split
* Occupant naming/addressing is split
* Channel creation is explicit IQ to service
* Channel join is explicit IQ to service
* User's server is involved in create/join/part to track channel occupancy
